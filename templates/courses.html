{% extends 'base.html' %}

{% block title %}My Courses{% endblock %}

{% block content %}
    <h2>My Courses</h2>

    <h3>Add New Course</h3>
    <form method="post">
        <label for="name">Course Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="credits">Credits:</label>
        <input type="number" id="credits" name="credits" step="0.5" min="0.5" required>

        <label>Calculation Method:</label><br>
        <input type="radio" id="method_final_grade" name="calculation_method" value="final_grade" checked>
        <label for="method_final_grade">Enter Final Grade</label><br>
        <input type="radio" id="method_components" name="calculation_method" value="components">
        <label for="method_components">Use Components (Assignments, Midterms, etc.)</label>
        <br><br>

        <div id="final_grade_input_section">
            <label for="grade_letter">Final Grade:</label>
            <select id="grade_letter" name="grade_letter">
                {% if available_grades %}
                    {% for grade in available_grades %}
                        <option value="{{ grade }}">{{ grade }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No grades defined. Please go to <a href="{{ url_for('grading_system') }}">Grading System</a> to add some!</option>
                {% endif %}
            </select>
        </div>
        <br>
        <button type="submit">Add Course</button>
    </form>

    {% if courses %}
        <h3>Your Added Courses</h3>
        <table>
            <thead>
                <tr>
                    <th>Course Name</th>
                    <th>Credits</th>
                    <th>Method</th>
                    <th>Grade</th> {# This will now display the effective grade #}
                    <th>Grade Point</th> {# This will now display the effective grade point #}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for course in courses %}
                    <tr>
                        <td>{{ course.name }}</td>
                        <td>{{ "%.1f" % course.credits }}</td>
                        <td>{{ 'Components' if course.calculation_method == 'components' else 'Final Grade' }}</td>
                        <td>{{ course.display_grade_letter }}</td>
                        <td>{{ course.display_grade_point }}</td>
                        <td>
                            <a href="{{ url_for('edit_course', course_id=course.id) }}" class="edit-btn">Edit</a>
                            {% if course.calculation_method == 'components' %}
                                <a href="{{ url_for('manage_components', course_id=course.id) }}" class="manage-components-btn">Manage Components</a>
                            {% endif %}
                            <form action="{{ url_for('delete_course', course_id=course.id) }}" method="post" style="display:inline;">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>You haven't added any courses yet. Add one above!</p>
    {% endif %}

    {# JavaScript to toggle final_grade_input_section based on radio button selection #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const methodFinalGrade = document.getElementById('method_final_grade');
            const methodComponents = document.getElementById('method_components');
            const finalGradeInputSection = document.getElementById('final_grade_input_section');

            function toggleFinalGradeInput() {
                if (methodFinalGrade.checked) {
                    finalGradeInputSection.style.display = 'block';
                    finalGradeInputSection.querySelector('select').setAttribute('required', 'true');
                } else {
                    finalGradeInputSection.style.display = 'none';
                    finalGradeInputSection.querySelector('select').removeAttribute('required');
                }
            }

            // Initial call on page load
            toggleFinalGradeInput();

            // Add event listeners
            methodFinalGrade.addEventListener('change', toggleFinalGradeInput);
            methodComponents.addEventListener('change', toggleFinalGradeInput);
        });
    </script>
{% endblock %}